#!/usr/bin/env bash
# syncrun: central script to rsync a project to a remote and run it there.
# Put this file in ~/bin/syncrun and ensure ~/bin is on your PATH.

set -euo pipefail

# ---------- Defaults ----------
DO_SYNC=1
DO_RUN=1
PULL_ENV=0
ON_SITE=0
RUN_ARGS=""

# Sensible defaults (can be overridden by configs)
REMOTE="lynx"
REMOTE_ON_SITE="saha@lynx.dfci.harvard.edu"
REMOTE_RUN_DIR="tmp/proj"
REMOTE_DATA="remote_env.RData"
LOCAL_DATA_DIR="./"

# rsync excludes (space-separated glob patterns)
RSYNC_EXCLUDES=(".git" "renv" ".Rproj.user" ".RData")

# Commands (override per project if needed)
RESTORE_CMD='Rscript -e "if (requireNamespace(\"renv\", quietly=TRUE)) renv::restore()"'  # safe if renv absent
RUN_CMD='R --quiet -e "source(\"run.R\"); save.image(\"remote_env.RData\")" --args __RUN_ARGS__'

# ---------- Helpers ----------
_here="$(pwd)"

run_hook() {
  local name="$1"
  local hook="./.syncrun/hooks/${name}"
  if [[ -x "$hook" ]]; then
    echo "[syncrun] Running hook: $name"
    "$hook"
  fi
}

join_excludes() {
  local args=()
  for pat in "${RSYNC_EXCLUDES[@]}"; do
    args+=("--exclude" "$pat")
  done
  printf '%s\n' "${args[@]}"
}

print_help_and_exit() {
  cat <<'EOF'
Usage:
syncrun [--no-sync] [--no-run] [--pull-env] [--onsite] [--help] [--] ARGS...

Examples:
syncrun lr=0.05 epochs=200   # sync + run (default)
syncrun --no-sync lr=0.05    # only run remotely
syncrun --no-run               # only sync
syncrun --pull-env             # pull remote_env.RData back
syncrun --onsite               # use REMOTE_ON_SITE instead of REMOTE

Config precedence:
built-in defaults <
~/.config/syncrun/config.sh <
./.syncrun/config.sh <
CLI flags

Project hooks (optional, executable files):
  ./.syncrun/hooks/pre_sync
     ./.syncrun/hooks/post_sync
     ./.syncrun/hooks/pre_run
     ./.syncrun/hooks/post_run
EOF
  exit 0
}

# ---------- Parse flags ----------
while [[ $# -gt 0 ]]; do
  case "$1" in
    --help) print_help_and_exit ;;
    --no-sync) DO_SYNC=0; shift ;;
    --no-run)  DO_RUN=0;  shift ;;
    --pull-env) PULL_ENV=1; shift ;;
    --onsite) ON_SITE=1; shift ;;
    --) shift; RUN_ARGS="$*"; break ;;
    *)
      # first non-flag: treat remainder as RUN_ARGS
      RUN_ARGS_ARR=("$@")
      break
      ;;
  esac
done

# ---------- Load configs (in order) ----------
if [[ -f "$HOME/.config/syncrun/config.sh" ]]; then
  # shellcheck disable=SC1090
  source "$HOME/.config/syncrun/config.sh"
fi

if [[ -f "$_here/.syncrun/config.sh" ]]; then
  # shellcheck disable=SC1091
  source "$_here/.syncrun/config.sh"
fi

# Decide remote after config overrides
if [[ $ON_SITE -eq 1 ]]; then
  REMOTE="$REMOTE_ON_SITE"
fi

# ---------- Do the work ----------
if [[ $DO_SYNC -eq 1 ]]; then
  run_hook pre_sync
  echo "[syncrun] Syncing to $REMOTE:$REMOTE_RUN_DIR ..."
  mapfile -t _ex < <(join_excludes)
  rsync -avzP --delete \
    -e "ssh" \
    "${_ex[@]}" \
    ./ "$REMOTE:$REMOTE_RUN_DIR/"
  run_hook post_sync
fi

if [[ $DO_RUN -eq 1 ]]; then
  run_hook pre_run
  echo "[syncrun] Running on $REMOTE in $REMOTE_RUN_DIR ..."
  # Safely substitute RUN_ARGS into RUN_CMD
  args_joined=""
  if [ "${RUN_ARGS_ARR+isset}" ] && ((${#RUN_ARGS_ARR[@]} > 0)); then
    args_joined="$(printf ' %q' "${RUN_ARGS_ARR[@]}")"
    args_joined="${args_joined# }"
  fi

  safe_run_cmd="${RUN_CMD/__RUN_ARGS__/$args_joined}"

  echo "$safe_run_cmd"
  ssh -t "$REMOTE" bash -lc "
  set -euo pipefail
  cd \"$REMOTE_RUN_DIR\"
  mkdir -p _outputs
  $RESTORE_CMD
  $safe_run_cmd
  "
  run_hook post_run
fi

if [[ $PULL_ENV -eq 1 ]]; then
  echo "[syncrun] Pulling remote data ..."
  rsync -avzP -e "ssh" "$REMOTE:$REMOTE_RUN_DIR/$REMOTE_DATA" "$LOCAL_DATA_DIR" || {
    echo '[syncrun] remote data not found (skipping). Check file location or SSH connection.'
  }
fi

